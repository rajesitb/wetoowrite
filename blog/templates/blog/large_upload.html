{% extends 'blog/base.html' %}
{% load static %}
{% load blog_tags %}
{% load crispy_forms_tags %}
{% load widget_tweaks %}
{% block content %}
    <div class="container" style="margin-top: 100px; margin-bottom: 50px;">
        <div class="row">
            <div class="col-md-12 mt-5">

                'Uploading a large file'


                <progress id="progressBar" style="height: 10px; width: 100%" max=”100” value=”0”></progress>
                <p class="text-center teal-text" id="percentageCalc"></p>
                <form action="{% url 'images-large' story.id %}" id="upload" method="post" enctype="multipart/form-data"
                      style="padding: 5px;">
                    {% csrf_token %}

                    <h2 class="mt-2">Upload Large Media Files</h2> <br>
                    {{ form.title_of_the_picture.label_tag }}
                    {{ form.title_of_the_picture|add_class:"form-control" }}
                    {{ form.describe_the_picture.label_tag }}
                    {{ form.describe_the_picture|add_class:"form-control" }}
                    <input type="file" class="btn btn-success" id="id_file_upload">
                    <input type="text" hidden name="file" id="id_file" value="">

                </form>

            </div>
        </div>
    </div>
{% endblock %}
{% block jquery %}
    <script>
        let uploadedFile;


        let postData = new FormData();
        (function () {
            document.getElementById("id_file_upload").onchange = function () {
                var files = document.getElementById("id_file_upload").files;
                var file = files[0];
                if (!file) {
                    return alert("No file selected.");
                }
                getSignedRequest(file);
            };

        })();

        function getSignedRequest(file) {
            let xhr = new XMLHttpRequest();
            xhr.open("GET", "/images-large-direct?file_name=" + file.name + "&file_type=" + file.type);
            console.log(file.size);
            xhr.onreadystatechange = function () {

                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        let response = JSON.parse(xhr.responseText);
                        uploadFile(file, response.data, response.url);
                         $('#id_file_upload').hide();
                    } else {
                        alert("Could not get signed URL.");
                    }
                }
            };
            xhr.send();
        }

        {#function for progress bar#}

        function progressFunction(evt) {
            var progressBar = document.getElementById("progressBar");
            var percentageDiv = document.getElementById("percentageCalc");
            if (evt.lengthComputable) {
                progressBar.max = evt.total;
                progressBar.value = evt.loaded;
                var percentage = Math.round(evt.loaded / evt.total * 100) + "%";
                let fileSize = Math.round(evt.total / 1000000) + "Mb";
                percentageDiv.innerHTML = `File Size ${fileSize}...   Uploaded ${percentage}`;
            }
        }

        function uploadFile(file, s3Data, url) {
            var xhr = new XMLHttpRequest();
            xhr.upload.addEventListener("progress", progressFunction, false);
            xhr.open("POST", s3Data.url);

            xhr.setRequestHeader('x-amz-acl', 'public-read');
            for (key in s3Data.fields) {
                postData.append(key, s3Data.fields[key]);
            }
            postData.append('file', file);

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    console.log('xhr', xhr.status);
                    if (xhr.status === 200 || xhr.status === 204) {
                        {#document.getElementById("preview").src = url;#}
                        document.getElementById("id_file").value = "{{ user }}" + "/" + file.name;

                        uploadedFile = $('#id_file').val();
                        let title = $('#id_title_of_the_picture').val();
                        let description = $('#id_describe_the_picture').val();
                        let story_id = '{{ story_id }}';

                        $.post({% url 'update-db' %}, {
                            uploadedFile: uploadedFile, title: title,
                            description: description, story_id: story_id
                        }, function (data) {
                            location.reload()
                        })
                    } else {
                        alert("Could not upload file.");
                    }
                }
            };
            xhr.send(postData)
        }

    </script>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
{% endblock jquery %}